# 전처리 과정 기록

## 목표
학생자살위기대응매뉴얼(교사용) PDF를 RAG 시스템에 최적화된 텍스트로 변환

## 핵심 도전 과제
1. **복잡한 PDF 레이아웃**: 2단 구성 (왼쪽: 면담 예시, 오른쪽: 질문 목록)
2. **텍스트 추출 품질**: 페이지 번호 섞임, 레이아웃 깨짐
3. **정보 손실**: 표, 박스, 다이어그램 영역

---

## 시도 과정

### 1단계: PDF 로더 비교 테스트

**목적**: 가장 좋은 텍스트 추출 방법 찾기

**테스트한 로더**:
```
- PyPDFLoader (pypdf 기반)
- PDFPlumberLoader
- PDFMinerLoader
- PyMuPDF (fitz)
- UnstructuredPDFLoader (의존성 충돌로 제외)
```

**평가 기준** (8점 만점):
1. 텍스트 길이 (3점): 1000자 이상
2. 페이지 번호 제거 (2점): "18 19\n" 패턴 없음
3. 핵심 키워드 포함 (2점): "자살", "징후", "대면", "면담"
4. 구조 보존 (1점): 리스트, 번호 유지

**결과**:
```
PyPDFLoader:      2.0/8 (851자, 페이지 번호 섞임)
PDFPlumberLoader: 4.0/8 (843자, 상대적으로 깨끗)
PDFMinerLoader:   4.0/8 (860자)
PyMuPDF:          2.0/8 (861자, 페이지 번호 섞임)
```

**1차 선택**: PDFPlumberLoader (4.0/8)
- 이유: 가장 높은 점수, 페이지 번호 처리 양호
- 문제: 여전히 텍스트 짧음, 목표 6.0/8 미달

---

### 2단계: OCR 시도

**가설**: PDF 로더가 놓치는 텍스트를 OCR로 추출 가능?

**방법**:
```python
pdf2image + pytesseract
- DPI: 300
- Lang: kor+eng
- PSM: 6 (Uniform text block)
```

**결과**:
```
전체 페이지 OCR: 36,291자 (vs PDFPlumber 11,000자)
→ 3.3배 증가! 🎉

하지만...
노이즈 분석:
- 유용한 텍스트: ~11,000자 (30%)
- 노이즈: ~25,000자 (70%)
  예: "ee", "oe", "©", "¢", "Dolor", "SACKS"
```

**노이즈 제거 시도**:
```python
정규식 기반 정리:
- 단일 문자 제거
- 레이아웃 기호 제거
- 특수문자 제거

결과:
원본: 36,291자
정리 후: 11,173자 (69.2% 제거)

→ PDFPlumber (11,000자)와 거의 같음!
→ OCR의 실질 이득 없음
```

**결론**: OCR 포기
- 이유: 노이즈가 너무 많아 정리 후 PDFPlumber와 동일
- 교훈: 복잡한 레이아웃의 텍스트 PDF는 OCR보다 텍스트 추출이 효율적

---

### 3단계: 2단 레이아웃 문제 발견

**문제 발견**:
```
매뉴얼 구조:
┌─────────────────┬─────────────────┐
│ 왼쪽: 면담 예시  │ 오른쪽: 질문 목록 │
│ 선생님 ↔ 학생   │ "그냥 영원히..." │
└─────────────────┴─────────────────┘

PDFPlumber 추출 결과:
면담 → 질문 → 면담 → 질문 (뒤섞임)
→ 맥락 깨짐! ❌
```

**실제 사례 (페이지 11)**:
```
기존: "대면면담 예시 ... 자살생각 유무에 대한 질문 ... 고민아..."
      ↑ 왼쪽 내용과 오른쪽 내용이 뒤섞여 있음

필요: 왼쪽 전체 → 오른쪽 전체 순서
```

---

### 4단계: PDFPlumber 레이아웃 기반 추출 (최종 해결)

**방법**: `within_bbox()` 사용하여 영역 분리

**구현**:
```python
with pdfplumber.open("data/manual.pdf") as pdf:
    page = pdf.pages[10]
    width = page.width
    height = page.height
    
    # 왼쪽 영역
    left_bbox = (0, 0, width/2, height)
    left = page.within_bbox(left_bbox)
    left_text = left.extract_text()
    
    # 오른쪽 영역
    right_bbox = (width/2, 0, width, height)
    right = page.within_bbox(right_bbox)
    right_text = right.extract_text()
    
    # 합치기
    combined = f"{left_text}\n\n{right_text}"
```

**결과** (페이지 11):
```
왼쪽 (~300자):
- 대면면담 예시
- ① 자살생각 확인하기
- 대화 예시 (선생님 ↔ 학생)
- Tip 포함
✅ 깔끔하게 분리!

오른쪽 (~500자):
- 자살생각 유무에 대한 질문
- 구체적 질문 목록
- 빈도/강도/기간 질문
✅ 완벽한 순서!

합계: ~800자
순서: 완벽! ✅
```

**최종 선택**: PDFPlumber + 레이아웃 기반 추출
- 품질: 순서 완벽, 맥락 보존
- 효율: 자동화 가능
- 안정성: 노이즈 최소

---

### 5단계: 수동 전처리 및 RAG 최적화

**전체 페이지 추출**:
```
총 32페이지 중:
- 표지/목차 제외 (p.1-6)
- 챕터 표지 제외 (p.18, 24, 28, 32)
- 실질 내용: 26페이지
- 최종 선택: 21페이지 (~18,000자)
```

**수동 정리 작업**:
```
1. 노이즈 제거:
   - 세로 텍스트 ("1\n자\n살")
   - 페이지 번호
   - 잔여 문자 ("입", "의" 등)

2. RAG 최적화:
   - 구조화 (섹션 구분, 제목 추가)
   - 리스트/표 → 번호 매김
   - Q&A, Tip 명확히 구분
   - 대화 예시 포맷팅
```

**최적화 예시**:
```
Before:
직접적 행동단서
'죽고 싶다'는 낙서
직접적인 언어표현
친구들에게...

After:
자살 징후의 종류

1. 직접적 행동 단서:
   • '죽고 싶다'는 낙서를 노트에 씀

2. 직접적 언어 표현:
   • 친구들에게...
```

---

## 최종 파이프라인
```
1. PDF 로딩 (PDFPlumber)
2. 레이아웃 기반 영역 분리 (왼쪽/오른쪽)
3. 전체 32페이지 추출 → txt 파일 저장
4. 수동 정리:
   - 표지/챕터 표지 삭제
   - 노이즈 제거 (세로 텍스트, 페이지 번호)
   - RAG 최적화 (구조화, 포맷팅)
5. 최종: 21페이지 (~18,000자)
6. 청킹 (RecursiveCharacterTextSplitter)
   - chunk_size: 1000
   - chunk_overlap: 200
   - 총 30개 청크 생성
7. 임베딩 (text-embedding-3-large, 3072차원)
8. Pinecone 저장 (student-counseling-0202)
```

---

## 핵심 페이지 선정

**전략 변경**:
```
초기 계획: 
- RAG에 핵심 페이지만 (14페이지)
- 시스템 프롬프트에 판단 기준

최종 결정:
- RAG에 거의 전부 (21페이지)
- 이유: 매뉴얼 자체가 작음 (32페이지)
  → 비용 문제 없음
  → 포괄적 검색 가능
```

**포함** (21페이지):
- p.7-17: 징후, 대면 면담, 위험/보호요인
- p.19-22: 사후개입, 가정통신문
- p.25-27: 상시관리, 고위험군 관리
- p.29-31: 기관 연락처

**제외** (11페이지):
- p.1-6: 표지, 목차, 서론
- p.18, 24, 28, 32: 챕터 표지
- p.23: 다이어그램 (텍스트 추출 어려움)

---

## 성능 비교

| 방법 | 글자수 | 순서 | 품질 | 채택 |
|------|--------|------|------|------|
| 기본 PDFPlumber | ~11,000자 | ❌ 뒤섞임 | 3/10 | ❌ |
| OCR + 정리 | 11,173자 | ⚠️ 노이즈 많음 | 4/10 | ❌ |
| **레이아웃 분리** | **~18,000자** | **✅ 완벽** | **7/10** | ⚠️ |
| **레이아웃 + 수동 최적화** | **~18,000자** | **✅ 완벽** | **9/10** | **✅** |

---

## 배운 점

1. **단순 비교보다 문제 분석이 중요**
   - 처음엔 "텍스트 양"에만 집중
   - 실제 문제는 "순서와 맥락"

2. **OCR은 만능이 아님**
   - 텍스트 PDF에서 OCR은 비효율적
   - 노이즈가 너무 많음

3. **도구의 숨은 기능 활용**
   - PDFPlumber의 `within_bbox()`
   - 처음부터 알았다면 시간 절약

4. **실제 데이터 확인 필수**
   - 통계(글자수)만 보지 말고
   - 실제 텍스트를 매뉴얼과 대조

5. **수동 전처리의 가치**
   - 자동화만으로는 한계
   - RAG 품질 = 데이터 품질
   - 26개 파일 수동 정리 → 2시간 투자
   - 결과: 검색 품질 대폭 향상

---

## 시간 투자

- PDF 로더 비교: 30분
- OCR 시도: 1시간
- 레이아웃 분리: 30분
- 수동 전처리: 2시간
- **총 4시간**

가치: 데이터 품질 = RAG 품질 = 프로젝트 품질

---

## 최종 결과
```
입력: manual.pdf (32페이지)
출력: 
- 21개 txt 파일 (data/all_pages_txt/)
- 총 18,000자
- 30개 청크
- Pinecone 인덱스: student-counseling-0202

검색 테스트:
✅ "자살 징후" → 관련 페이지 정확히 검색
✅ "죽고 싶다고 말하면" → 대응 방법 정확히 검색
✅ "부모에게 알리기" → 가정통신문 예시 검색
```

---

## 코드 위치 (최종)
```
preprocessing/
├── extract_all_pages.py       # 전체 페이지 추출 (채택) ✅
└── chunk_and_embed.py          # 청킹 + 임베딩 (채택) ✅

archive/preprocessing-experiments/
├── step1_load_pdf.py           # 로더 비교
├── test_ocr.py                 # OCR 테스트
├── ocr_all_pages.py            # OCR 전체
├── clean_ocr.py                # OCR 노이즈 제거
├── test_layout.py              # 레이아웃 테스트
└── extract_all_with_layout.py  # 레이아웃 추출 (초안)

data/
├── manual.pdf                  # 원본
└── all_pages_txt/              # 최종 전처리 결과 ✅

archive/data-experiments/
├── pdfplumber_results/         # 기본 추출
├── ocr_results/                # OCR 원본
├── ocr_cleaned/                # OCR 정리
├── layout_test/                # 레이아웃 테스트
└── layout_extracted/           # 레이아웃 추출 초기
```

---

## 인터뷰 예상 질문 & 답변

**Q: 왜 OCR을 포기했나요?**
A: OCR 결과가 36,000자였지만 노이즈가 70%였습니다. 정리 후 11,000자로 기본 PDFPlumber와 동일했고, 노이즈 제거에 추가 시간이 필요해 비효율적이었습니다. 텍스트 PDF는 직접 추출이 더 효과적임을 배웠습니다.

**Q: 레이아웃 분리를 어떻게 생각했나요?**
A: 추출된 텍스트를 실제 매뉴얼과 대조하다가 순서가 뒤섞인 걸 발견했습니다. 매뉴얼이 2단 구성임을 확인하고, PDFPlumber의 `within_bbox()` 기능으로 영역을 분리하여 해결했습니다.

**Q: 수동 전처리에 2시간을 투자한 이유는?**
A: 자동화만으로는 RAG 최적화에 한계가 있었습니다. 구조화, 포맷팅, 노이즈 제거를 통해 검색 품질이 대폭 향상되었고, 매뉴얼 규모가 작아(26페이지) 수동 작업이 충분히 가치가 있다고 판단했습니다.

**Q: 처음 계획과 달라진 점은?**
A: 초기에는 핵심 페이지만 RAG에 넣고 판단 기준은 시스템 프롬프트에 넣으려 했습니다. 하지만 매뉴얼이 작아서 거의 전부를 RAG에 넣는 것으로 변경했고, 이를 통해 포괄적 검색이 가능해졌습니다.

**Q: 가장 어려웠던 부분은?**
A: 2단 레이아웃 문제 발견과 해결이었습니다. 통계(글자수)로는 문제를 알 수 없었고, 실제 텍스트를 매뉴얼과 한 줄씩 대조해야 발견할 수 있었습니다. 이를 통해 데이터 검증의 중요성을 배웠습니다.