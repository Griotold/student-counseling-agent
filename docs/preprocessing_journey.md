# 전처리 과정 기록

## 목표
학생자살위기대응매뉴얼(교사용) PDF를 RAG 시스템에 최적화된 텍스트로 변환

## 핵심 도전 과제
1. **복잡한 PDF 레이아웃**: 2단 구성 (왼쪽: 면담 예시, 오른쪽: 질문 목록)
2. **텍스트 추출 품질**: 페이지 번호 섞임, 레이아웃 깨짐
3. **정보 손실**: 표, 박스, 다이어그램 영역

---

## 시도 과정

### 1단계: PDF 로더 비교 테스트

**목적**: 가장 좋은 텍스트 추출 방법 찾기

**테스트한 로더**:
```
- PyPDFLoader (pypdf 기반)
- PDFPlumberLoader
- PDFMinerLoader
- PyMuPDF (fitz)
- UnstructuredPDFLoader (의존성 충돌로 제외)
```

**평가 기준** (8점 만점):
1. 텍스트 길이 (3점): 1000자 이상
2. 페이지 번호 제거 (2점): "18 19\n" 패턴 없음
3. 핵심 키워드 포함 (2점): "자살", "징후", "대면", "면담"
4. 구조 보존 (1점): 리스트, 번호 유지

**결과**:
```
PyPDFLoader:      2.0/8 (851자, 페이지 번호 섞임)
PDFPlumberLoader: 4.0/8 (843자, 상대적으로 깨끗)
PDFMinerLoader:   4.0/8 (860자)
PyMuPDF:          2.0/8 (861자, 페이지 번호 섞임)
```

**1차 선택**: PDFPlumberLoader (4.0/8)
- 이유: 가장 높은 점수, 페이지 번호 처리 양호
- 문제: 여전히 텍스트 짧음, 목표 6.0/8 미달

---

### 2단계: OCR 시도

**가설**: PDF 로더가 놓치는 텍스트를 OCR로 추출 가능?

**방법**:
```python
pdf2image + pytesseract
- DPI: 300
- Lang: kor+eng
- PSM: 6 (Uniform text block)
```

**결과**:
```
전체 페이지 OCR: 36,291자 (vs PDFPlumber 11,000자)
→ 3.3배 증가! 🎉

하지만...
노이즈 분석:
- 유용한 텍스트: ~11,000자 (30%)
- 노이즈: ~25,000자 (70%)
  예: "ee", "oe", "©", "¢", "Dolor", "SACKS"
```

**노이즈 제거 시도**:
```python
정규식 기반 정리:
- 단일 문자 제거
- 레이아웃 기호 제거
- 특수문자 제거

결과:
원본: 36,291자
정리 후: 11,173자 (69.2% 제거)

→ PDFPlumber (11,000자)와 거의 같음!
→ OCR의 실질 이득 없음
```

**결론**: OCR 포기
- 이유: 노이즈가 너무 많아 정리 후 PDFPlumber와 동일
- 교훈: 복잡한 레이아웃의 텍스트 PDF는 OCR보다 텍스트 추출이 효율적

---

### 3단계: 2단 레이아웃 문제 발견

**문제 발견**:
```
매뉴얼 구조:
┌─────────────────┬─────────────────┐
│ 왼쪽: 면담 예시  │ 오른쪽: 질문 목록 │
│ 선생님 ↔ 학생   │ "그냥 영원히..." │
└─────────────────┴─────────────────┘

PDFPlumber 추출 결과:
면담 → 질문 → 면담 → 질문 (뒤섞임)
→ 맥락 깨짐! ❌
```

**실제 사례 (페이지 11)**:
```
기존: "대면면담 예시 ... 자살생각 유무에 대한 질문 ... 고민아..."
      ↑ 왼쪽 내용과 오른쪽 내용이 뒤섞여 있음

필요: 왼쪽 전체 → 오른쪽 전체 순서
```

---

### 4단계: PDFPlumber 레이아웃 기반 추출 (최종 해결)

**방법**: `within_bbox()` 사용하여 영역 분리

**구현**:
```python
with pdfplumber.open("data/manual.pdf") as pdf:
    page = pdf.pages[10]
    width = page.width
    
    # 왼쪽 영역
    left_bbox = (0, 0, width/2, height)
    left = page.within_bbox(left_bbox)
    left_text = left.extract_text()
    
    # 오른쪽 영역
    right_bbox = (width/2, 0, width, height)
    right = page.within_bbox(right_bbox)
    right_text = right.extract_text()
    
    # 합치기
    combined = f"{left_text}\n\n{right_text}"
```

**결과** (페이지 11):
```
왼쪽 (~300자):
- 대면면담 예시
- ① 자살생각 확인하기
- 대화 예시 (선생님 ↔ 학생)
- Tip 포함
✅ 깔끔하게 분리!

오른쪽 (~500자):
- 자살생각 유무에 대한 질문
- 구체적 질문 목록
- 빈도/강도/기간 질문
✅ 완벽한 순서!

합계: ~800자
순서: 완벽! ✅
```

**최종 선택**: PDFPlumber + 레이아웃 기반 추출
- 품질: 순서 완벽, 맥락 보존
- 효율: 자동화 가능
- 안정성: 노이즈 최소

---

## 최종 파이프라인
```
1. PDF 로딩 (PDFPlumber)
2. 레이아웃 기반 영역 분리 (왼쪽/오른쪽)
3. 텍스트 추출 및 결합
4. 경량 전처리:
   - 페이지 번호 제거 ("18", "19")
   - 세로 텍스트 제거 ("1\n자\n살")
   - 다중 개행 정리
5. 청킹 (RecursiveCharacterTextSplitter)
6. 임베딩 (text-embedding-3-large)
7. Pinecone 저장
```

---

## 핵심 페이지 선정

**포함**:
- p.11-14: 대면 면담 방법 (구체적 대화)
- p.18-20: 면담 진행 방법
- p.24-26: 위기 개입
- p.27-30: 위험요인/보호요인

**제외**:
- p.9-10: 자살 위기 수준 판단 기준
  - 이유: 구조화된 체크리스트 → 시스템 프롬프트로 하드코딩

**총**: 14페이지

---

## 성능 비교

| 방법 | 글자수 | 순서 | 품질 | 채택 |
|------|--------|------|------|------|
| 기본 PDFPlumber | ~11,000자 | ❌ 뒤섞임 | 3/10 | ❌ |
| OCR + 정리 | 11,173자 | ⚠️ 노이즈 많음 | 4/10 | ❌ |
| **레이아웃 분리** | **~11,000자** | **✅ 완벽** | **8/10** | **✅** |

---

## 배운 점

1. **단순 비교보다 문제 분석이 중요**
   - 처음엔 "텍스트 양"에만 집중
   - 실제 문제는 "순서와 맥락"

2. **OCR은 만능이 아님**
   - 텍스트 PDF에서 OCR은 비효율적
   - 노이즈가 너무 많음

3. **도구의 숨은 기능 활용**
   - PDFPlumber의 `within_bbox()`
   - 처음부터 알았다면 시간 절약

4. **실제 데이터 확인 필수**
   - 통계(글자수)만 보지 말고
   - 실제 텍스트를 매뉴얼과 대조

---

## 시간 투자

- PDF 로더 비교: 30분
- OCR 시도: 1시간
- 레이아웃 분리: 30분
- **총 2시간**

가치: 데이터 품질 = RAG 품질 = 프로젝트 품질

---

## 코드 위치
```
preprocessing/
├── step1_load_pdf.py          # 로더 비교
├── test_ocr.py                # OCR 테스트
├── ocr_all_pages.py           # OCR 전체
├── clean_ocr.py               # OCR 노이즈 제거
├── test_layout.py             # 레이아웃 테스트
└── extract_all_with_layout.py # 최종 추출 (채택)

data/
├── pdfplumber_results/        # 기본 추출
├── ocr_results/               # OCR 원본
├── ocr_cleaned/               # OCR 정리
├── layout_test/               # 레이아웃 테스트
└── layout_extracted/          # 최종 추출 ✅
```

---

## 인터뷰 예상 질문 & 답변

**Q: 왜 OCR을 포기했나요?**
A: OCR 결과가 36,000자였지만 노이즈가 70%였습니다. 정리 후 11,000자로 기본 PDFPlumber와 동일했고, 노이즈 제거에 추가 시간이 필요해 비효율적이었습니다. 텍스트 PDF는 직접 추출이 더 효과적임을 배웠습니다.

**Q: 레이아웃 분리를 어떻게 생각했나요?**
A: 추출된 텍스트를 실제 매뉴얼과 대조하다가 순서가 뒤섞인 걸 발견했습니다. 매뉴얼이 2단 구성임을 확인하고, PDFPlumber의 `within_bbox()` 기능으로 영역을 분리하여 해결했습니다.

**Q: 다른 방법도 고려했나요?**
A: 네, 3가지를 고려했습니다: 1) 여러 PDF 로더 비교, 2) OCR, 3) 레이아웃 기반 추출. 각각 장단점이 있었고, 실험을 통해 레이아웃 분리가 최적임을 확인했습니다.

**Q: 시간이 오래 걸리지 않았나요?**
A: 2시간 투자했습니다. 하지만 데이터 품질이 RAG 성능을 결정하므로, 초기 전처리에 시간을 투자하는 게 전체 프로젝트 품질 향상에 필수적이라고 판단했습니다.